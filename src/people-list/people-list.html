<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">


<link rel="import" href="../components/people-card/people-card.html">
<link rel="import" href="../components/people-service/people-service.html">
<link rel="import" href="../components/people-behaviors/people-route-behavior.html">
<link rel="import" href="./people-list-add.html">


<dom-module id="people-list">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host {
                display: block;
                padding: 20px;
                width: 90%;
                color: var(--primary-color);
            }

            .search {
                margin-right: 20px;
            }


        </style>

        <!-- DATA SERVICES -->
        <people-service id="peopleService" peoples="{{peoples}}"
                        on-create-success="onCreate"
                        on-delete-success="onDelete"></people-service>

        <!-- Subroutes -->
        <app-route
                route="{{route}}"
                pattern="/:subpage"
                data="{{routeData}}"
                tail="{{subroute}}">
        </app-route>



        <section class="header layout horizontal center">
            <h2 class="flex">You have {{peoples.length}} contact(s)</h2>

        </section>


        <section name="card">
            <paper-input class="search flex" value="{{filter    }}" label="Filter by name"></paper-input>
            <div class="list layout horizontal wrap center-justified">
                <template id="peoplesRepeat" is="dom-repeat" items="{{peoples}}" filter="filterOnName">
                    <people-card people="{{item}}" can-delete can-edit on-delete-people="deletePeople"></people-card>
                </template>
            </div>

            <people-list-add id="addDialog"></people-list-add>


        </section>


    </template>

    <script>
        (function() {
            'use strict';
            Polymer({
                is : 'people-list',
                behaviors:[PeopleRouteBehavior],
                properties : {
                    peoples : {
                        type : Array
                    },
                    filter : {
                        type     : String,
                        observer : 'filterChanged'
                    }
                },
                observers: [
                    '_routePageChanged(routeData.subpage)'
                ],
                listeners : {
                    'addDialog.close-create-people': 'onClose',
                    'addDialog.create-people' : 'createPeople'
                },
                getPeoples: function() {
                    this.$.peopleService.getPeoples();
                },
                _routePageChanged: function (page) {
                    if (page === 'add') {
                        this.openDialog();
                    }
                    else {
                        this.closeDialog();
                    }
                    if (page) {
                        this.page = page
                    }
                    else {
                        this.set('route.path', '/card');
                        this.page = 'card';
                    }
                },
                filterOnName : function(item) {
                    var filter = this.filter.toLowerCase();
                    return (item.firstname.toLowerCase().indexOf(filter) != -1
                    || item.lastname.toLowerCase().indexOf(filter) != -1)
                },
                filterChanged : function() {
                    this.$.peoplesRepeat.render();
                },
                openDialog : function() {
                    this.$.addDialog.open();
                },
                closeDialog : function() {
                    this.$.addDialog.close();
                },
                createPeople : function(e) {
                    var people = e.detail;
                    this.$.peopleService.createPeople(people);
                },
                onClose: function () {
                    this.set('route.path', '/card');
                },
                onCreate : function() {
                    this.set('route.path', '/card');
                    this.$.peopleService.getPeoples();
                },
                deletePeople: function (e) {
                    this.$.peopleService.deletePeople(e.detail);
                },
                onDelete: function (event) {
                    this.peoples = event.detail;
                },
                onShow: function () {
                    this.getPeoples();
                },
                onHide: function () {
                    this.page = "";
                }
            });
        })();
    </script>
</dom-module>